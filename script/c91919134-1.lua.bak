--天印·灵威仰
local s, id, o = GetID()
s.name = "天印·灵威仰"
function s.initial_effect(c)
	s.PublicEffect(c)
	s.PrivateEffect(c)
end

function s.PublicEffect(c)
	c:SetUniqueOnField(1, 0, id, LOCATION_MZONE)
	--融合召唤手续
	aux.AddFusionProcFunFunRep(c, s.mfilter1, s.mfilter2, 2, 127, true)
	aux.AddContactFusionProcedure(c, aux.FilterBoolFunction(Card.IsReleasable, REASON_SPSUMMON),
		LOCATION_HAND + LOCATION_MZONE, 0, Duel.Release, REASON_MATERIAL + REASON_FUSION):SetValue(SUMMON_TYPE_FUSION)
	c:EnableReviveLimit()
	--特殊召唤限制
	local e1 = Effect.CreateEffect(c)
	e1:SetProperty(EFFECT_FLAG_CANNOT_DISABLE + EFFECT_FLAG_UNCOPYABLE)
	e1:SetType(EFFECT_TYPE_SINGLE)
	e1:SetCode(EFFECT_SPSUMMON_CONDITION)
	e1:SetRange(LOCATION_EXTRA)
	e1:SetValue(aux.fuslimit)
	c:RegisterEffect(e1)
	--放置指示物
	local e2 = Effect.CreateEffect(c)
	e2:SetProperty(EFFECT_FLAG_CANNOT_DISABLE + EFFECT_FLAG_UNCOPYABLE)
	e2:SetType(EFFECT_TYPE_SINGLE + EFFECT_TYPE_CONTINUOUS)
	e2:SetCode(EVENT_SPSUMMON_SUCCESS)
	e2:SetCondition(s.settlecon)
	e2:SetOperation(s.settleop)
	c:RegisterEffect(e2)
	local e3 = Effect.CreateEffect(c)
	e3:SetProperty(EFFECT_FLAG_CANNOT_DISABLE + EFFECT_FLAG_UNCOPYABLE)
	e3:SetType(EFFECT_TYPE_SINGLE)
	e3:SetCode(EFFECT_MATERIAL_CHECK)
	e3:SetValue(s.settleval)
	e3:SetLabelObject(e2)
	c:RegisterEffect(e3)
	--指示物累计取除数值
	if not aux.SkyCodeCheck then
		aux.SkyCodeCheck = true
		aux.SkyCodeSub = 91919134 --累计取除的指示物数量
		aux.SkyCodeNow = 919191340 --当前放置的指示物数量
		aux.SkyCodeOperation()
	end
end

function s.mfilter1(c)
	return c:IsFusionSetCard(0x1091)
end

function s.mfilter2(c, fc)
	return c:IsLevel(4) or c:IsFusionAttribute(fc:GetOriginalAttribute())
end

function s.settlecon(e)
	return e:GetHandler():IsSummonType(SUMMON_TYPE_FUSION)
end

function s.settleop(e, tp, eg, ep, ev, re, r, rp)
	local c = e:GetHandler()
	local ct = c:GetMaterialCount()
	local ect = e:GetLabel()
	c:AddCounter(0x1091, ct + ect)
end

function s.settleval(e, c)
	local val = c:GetMaterial():GetSum(Card.GetCounter, 0x1091)
	e:GetLabelObject():SetLabel(val)
end

function aux.SkyCodeOperation()
	Duel._RemoveCounter = Duel.RemoveCounter
	Card._RemoveCounter = Card.RemoveCounter
	Card._AddCounter = Card.AddCounter
	Duel.RemoveCounter = function(tp, loc_s, loc_o, ctype, ct, reason)
		if ctype ~= 0x1091 then
			return Duel._RemoveCounter(tp, loc_s, loc_o, ctype, ct, reason)
		end
		s.Calculate()
		local res = Duel._RemoveCounter(tp, loc_s, loc_o, ctype, ct, reason)
		s.Calculate()
		return res
	end
	Card.RemoveCounter = function(c, tp, ctype, ct, reason)
		if ctype ~= 0x1091 then
			return Card._RemoveCounter(c, tp, ctype, ct, reason)
		end
		s.Calculate()
		local res = Card._RemoveCounter(c, tp, ctype, ct, reason)
		s.Calculate()
		return res
	end
	Card.AddCounter = function(c, ctype, ct, singly)
		if ctype ~= 0x1091 then
			return Card._AddCounter(c, ctype, ct, singly)
		end
		s.Calculate()
		local res = Card._AddCounter(c, ctype, ct, singly)
		s.Calculate()
		return res
	end
end

function s.CalculateFilter(c)
	if not c:IsType(TYPE_MONSTER) then return false end
	local code_now = aux.SkyCodeNow
	local code_sub = aux.SkyCodeSub
	local ct_now = c:GetFlagEffectLabel(code_now)
	local ct_sub = c:GetFlagEffectLabel(code_sub)
	local ct = c:GetCounter(0x1091)
	return not ct_now or not ct_sub or ct_now ~= ct
end

function s.Calculate()
	local g = Duel.GetMatchingGroup(s.CalculateFilter, tp, LOCATION_MZONE, LOCATION_MZONE, nil)
	if g:GetCount() == 0 then return end
	local code_sub = aux.SkyCodeSub			  --累计取除指示物数量
	local code_now = aux.SkyCodeNow			  --当前放置的指示物数量
	for tc in aux.Next(g) do
		local ct_sub = tc:GetFlagEffectLabel(code_sub) --该flag为指示物累计下降数值的计数器
		local ct_now = tc:GetFlagEffectLabel(code_now) --该flag为指示物标识器,滞后于实际指示物变化
		local ct = tc:GetCounter(0x1091)
		if not ct_sub then
			ct_sub = 0
			tc:RegisterFlagEffect(code_sub, RESET_EVENT + RESETS_STANDARD - RESET_TURN_SET, 0, 1, 0)
		end
		if not ct_now then
			ct_now = 0
			tc:RegisterFlagEffect(code_now, RESET_EVENT + RESETS_STANDARD - RESET_TURN_SET, 0, 1, 0)
		end
		if ct < ct_now then
			local ct_result = ct_sub + math.abs(ct_now - ct)
			tc:ResetFlagEffect(code_sub)
			tc:RegisterFlagEffect(code_sub, RESET_EVENT + RESETS_STANDARD - RESET_TURN_SET, 0, 1, ct_result)
			tc:ResetFlagEffect(code_now)
			tc:RegisterFlagEffect(code_now, RESET_EVENT + RESETS_STANDARD - RESET_TURN_SET, 0, 1, ct)
		elseif ct > ct_now then
			tc:ResetFlagEffect(code_now)
			tc:RegisterFlagEffect(code_now, RESET_EVENT + RESETS_STANDARD - RESET_TURN_SET, 0, 1, ct)
		end
	end
	Duel.Readjust()
end

function s.PrivateEffect(c)
	--除外对方卡组
	local e0 = Effect.CreateEffect(c)
	e0:SetDescription(aux.Stringid(id, 0))
	e0:SetCategory(CATEGORY_REMOVE)
	e0:SetType(EFFECT_TYPE_QUICK_O)
	e0:SetCode(EVENT_FREE_CHAIN)
	e0:SetRange(LOCATION_MZONE)
	e0:SetHintTiming(TIMINGS_CHECK_MONSTER + TIMING_BATTLE_PHASE)
	e0:SetCountLimit(1, EFFECT_COUNT_CODE_CHAIN)
	e0:SetTarget(s.remtg)
	e0:SetOperation(s.remop)
	c:RegisterEffect(e0)
	--攻守上升
	local e1 = Effect.CreateEffect(c)
	e1:SetDescription(aux.Stringid(id, 4))
	e1:SetProperty(EFFECT_FLAG_SINGLE_RANGE + EFFECT_FLAG_CLIENT_HINT)
	e1:SetType(EFFECT_TYPE_SINGLE)
	e1:SetCode(EFFECT_UPDATE_ATTACK)
	e1:SetRange(LOCATION_MZONE)
	e1:SetValue(s.efval1)
	e1:SetLabel(1)
	local ge1 = Effect.CreateEffect(c)
	ge1:SetType(EFFECT_TYPE_FIELD + EFFECT_TYPE_GRANT)
	ge1:SetRange(LOCATION_MZONE)
	ge1:SetTargetRange(LOCATION_MZONE, 0)
	ge1:SetTarget(s.eftg)
	ge1:SetLabelObject(e1)
	c:RegisterEffect(ge1)
	local re1 = e1:Clone()
	re1:SetCode(EFFECT_UPDATE_DEFENSE)
	local rge1 = ge1:Clone()
	rge1:SetLabelObject(re1)
	c:RegisterEffect(rge1)
	--卡组抽卡
	local e2 = Effect.CreateEffect(c)
	e2:SetDescription(aux.Stringid(id, 5))
	e2:SetCategory(CATEGORY_DRAW)
	e2:SetProperty(EFFECT_FLAG_SINGLE_RANGE + EFFECT_FLAG_CLIENT_HINT)
	e2:SetType(EFFECT_TYPE_IGNITION)
	e2:SetRange(LOCATION_MZONE)
	e2:SetCountLimit(1)
	e2:SetLabel(2)
	e2:SetCost(s.drcost)
	e2:SetTarget(s.drtg)
	e2:SetOperation(s.drop)
	local ge2 = ge1:Clone()
	ge2:SetLabelObject(e2)
	c:RegisterEffect(ge2)
	--效果免疫
	local e3 = Effect.CreateEffect(c)
	e3:SetDescription(aux.Stringid(id, 6))
	e3:SetProperty(EFFECT_FLAG_SINGLE_RANGE + EFFECT_FLAG_CLIENT_HINT)
	e3:SetType(EFFECT_TYPE_SINGLE)
	e3:SetCode(EFFECT_IMMUNE_EFFECT)
	e3:SetRange(LOCATION_MZONE)
	e3:SetValue(s.efval2)
	e3:SetLabel(3)
	e3:SetOwnerPlayer(tp)
	local ge3 = ge1:Clone()
	ge3:SetLabelObject(e3)
	c:RegisterEffect(ge3)
end

function s.remfilter(c, tp)
	return c:GetFlagEffect(id + o) == 0
		and c:IsCanRemoveCounter(tp, 0x1091, 1, REASON_COST)
end
function s.fcheck(c, seq)
	return c:GetSequence() == seq
end

function s.remtg(e, tp, eg, ep, ev, re, r, rp, chk)
	if chk == 0 then
		local g = Duel.GetDecktopGroup(1 - tp, 1)
		local tc = g:GetFirst()
		return tc and tc:IsAbleToRemove()
			and Duel.IsExistingMatchingCard(s.remfilter, tp, LOCATION_ONFIELD, 0, 1, nil, tp)
	end
	local Min = 1
	local Deck = Duel.GetFieldGroup(tp, 0, LOCATION_DECK) --对方卡组
	local Deck_Count = Deck:GetCount()				 --卡组总数量
	Debug.Message(string.format("对方卡组数量 : %s", Deck_Count))
	local Select_Count = 0							 --累计数量
	local Sequence_Count = 1						   --序号
	local Deck_top = Deck:Filter(s.fcheck, nil, Deck_Count - Select_Count - Sequence_Count):GetFirst()
	local flag = Group.CreateGroup()
	while Deck_top and Deck_top:IsAbleToRemove() and Duel.IsExistingMatchingCard(s.remfilter, tp, LOCATION_ONFIELD, 0, 1, nil, tp) do
		Duel.Hint(HINT_SELECTMSG, tp, aux.Stringid(id, 1))
		local g = Duel.SelectMatchingCard(tp, s.remfilter, tp, LOCATION_ONFIELD, 0, Min, 1, nil)
		if not g or g:GetCount() == 0 then break end
		local tc = g:GetFirst()
		Sequence_Count = 1
		Deck_top = Deck:Filter(s.fcheck, nil, Deck_Count - Select_Count - Sequence_Count):GetFirst()
		local Announce_List = {}
		while Deck_top and Deck_top:IsAbleToRemove() and tc:IsCanRemoveCounter(tp, 0x1091, Sequence_Count, REASON_COST) do
			Announce_List[Sequence_Count] = Sequence_Count
			Sequence_Count = Sequence_Count + 1
			Deck_top = Deck:Filter(s.fcheck, nil, Deck_Count - Select_Count - Sequence_Count):GetFirst()
		end
		Duel.Hint(HINT_SELECTMSG, tp, aux.Stringid(id, 2))
		local Announce_Count = Duel.AnnounceNumber(tp, table.unpack(Announce_List))
		Select_Count = Select_Count + Announce_Count
		tc:RemoveCounter(tp, 0x1091, Announce_Count, REASON_COST)
		if not flag:IsContains(tc) then
			flag:AddCard(tc)
		end
		Deck_top = Deck:Filter(s.fcheck, nil, Deck_Count - Select_Count - 1):GetFirst()
		if Min ~= 0 then Min = 0 end
	end
	for fc in aux.Next(flag) do
		fc:RegisterFlagEffect(id + o, RESET_EVENT + RESETS_STANDARD + RESET_PHASE + PHASE_END, EFFECT_FLAG_CLIENT_HINT, 1, 0,
		aux.Stringid(id, 3))
	end
	Duel.SetTargetPlayer(1 - tp)
	Duel.SetTargetParam(Select_Count)
	Duel.SetOperationInfo(0, CATEGORY_REMOVE, nil, Select_Count, 1 - tp, LOCATION_DECK)
end

function s.remop(e, tp, eg, ep, ev, re, r, rp)
	if Duel.GetFieldGroupCount(tp, 0, LOCATION_DECK) == 0 then return end
	local p, d = Duel.GetChainInfo(0, CHAININFO_TARGET_PLAYER, CHAININFO_TARGET_PARAM)
	local g = Duel.GetDecktopGroup(p, d)
	local sg = g:Filter(Card.IsAbleToRemove, nil)
	if sg:GetCount()>0 then
		Duel.DisableShuffleCheck()
		Duel.Remove(sg, POS_FACEDOWN, REASON_EFFECT)
	end
end

function s.eftg(e, c)
	local code_sub = aux.SkyCodeSub
	local ct1 = c:GetFlagEffectLabel(code_sub) or 0
	return ct1 >= e:GetLabelObject():GetLabel()
end

function s.efval1(e, c)
	local code_sub = aux.SkyCodeSub
	local ct1 = c:GetFlagEffectLabel(code_sub) or 0
	return ct1 * 500
end

function s.drcost(e, tp, eg, ep, ev, re, r, rp, chk)
	if chk == 0 then return e:GetHandler():IsCanRemoveCounter(tp, 0x1091, 1, REASON_COST) end
	e:GetHandler():RemoveCounter(tp, 0x1091, 1, REASON_COST)
end

function s.drtg(e, tp, eg, ep, ev, re, r, rp, chk)
	if chk == 0 then return Duel.IsPlayerCanDraw(tp, 1) end
	Duel.SetTargetPlayer(tp)
	Duel.SetTargetParam(1)
	Duel.SetOperationInfo(0, CATEGORY_DRAW, nil, 0, tp, 1)
end

function s.drop(e, tp, eg, ep, ev, re, r, rp)
	local p, d = Duel.GetChainInfo(0, CHAININFO_TARGET_PLAYER, CHAININFO_TARGET_PARAM)
	Duel.Draw(p, d, REASON_EFFECT)
end

function s.efval2(e, re)
	return e:GetHandlerPlayer() ~= re:GetOwnerPlayer()
end
